## 多核、缓存...现代CPU是如何工作的
<blockquote> 现代CPU一般使用缓存（Cache）来解决CPU读写主存慢的问题；使用多核来并行计算以加速程序运行。并行计算一般需要多线程技术，如何操作多线程对编程人员提出了挑战。</blockquote><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-b1388bef893de134dccfe3fbb2fe6ae4_b.jpg" data-size="normal" data-rawwidth="576" data-rawheight="446" class="origin_image zh-lightbox-thumb" width="576" data-original="https://pic1.zhimg.com/v2-b1388bef893de134dccfe3fbb2fe6ae4_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;576&#39; height=&#39;446&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="576" data-rawheight="446" class="origin_image zh-lightbox-thumb lazy" width="576" data-original="https://pic1.zhimg.com/v2-b1388bef893de134dccfe3fbb2fe6ae4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-b1388bef893de134dccfe3fbb2fe6ae4_b.jpg"/><figcaption>计算机软硬件体系结构</figcaption></figure><p>之前的文章</p><a target="_blank" href="https://zhuanlan.zhihu.com/p/72139066" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-530c52de9aca056d51531097af6057ad_180x120.jpg" data-image-width="1280" data-image-height="853" class="LinkCard LinkCard--hasImage"><span class="LinkCard-backdrop" style="background-image:url(https://pic2.zhimg.com/v2-530c52de9aca056d51531097af6057ad_180x120.jpg)"></span><span class="LinkCard-content"><span class="LinkCard-text"><span class="LinkCard-title" data-text="true">PP鲁：计算机基础系列：源代码如何被计算机执行</span><span class="LinkCard-meta"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--InsertLink" fill="currentColor" viewBox="0 0 24 24" width="17" height="17"><path d="M6.77 17.23c-.905-.904-.94-2.333-.08-3.193l3.059-3.06-1.192-1.19-3.059 3.058c-1.489 1.489-1.427 3.954.138 5.519s4.03 1.627 5.519.138l3.059-3.059-1.192-1.192-3.059 3.06c-.86.86-2.289.824-3.193-.08zm3.016-8.673l1.192 1.192 3.059-3.06c.86-.86 2.289-.824 3.193.08.905.905.94 2.334.08 3.194l-3.059 3.06 1.192 1.19 3.059-3.058c1.489-1.489 1.427-3.954-.138-5.519s-4.03-1.627-5.519-.138L9.786 8.557zm-1.023 6.68c.33.33.863.343 1.177.029l5.34-5.34c.314-.314.3-.846-.03-1.176-.33-.33-.862-.344-1.176-.03l-5.34 5.34c-.314.314-.3.846.03 1.177z" fill-rule="evenodd"></path></svg></span>zhuanlan.zhihu.com</span></span><span class="LinkCard-imageCell"><img class="LinkCard-image LinkCard-image--horizontal" alt="图标" src="https://pic2.zhimg.com/v2-530c52de9aca056d51531097af6057ad_180x120.jpg"/></span></span></a><p>已经提到，对于一段源代码，计算机主要依靠编译器将源代码转化为CPU可以执行的程序。那么，CPU到底是如何工作的呢？本文将介绍现代CPU的工作原理。</p><h2><b>冯·诺依曼架构</b></h2><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-9f75ee4b4d480005ff116b1beaceb123_b.jpg" data-size="normal" data-rawwidth="2560" data-rawheight="1481" class="origin_image zh-lightbox-thumb" width="2560" data-original="https://pic4.zhimg.com/v2-9f75ee4b4d480005ff116b1beaceb123_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;2560&#39; height=&#39;1481&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2560" data-rawheight="1481" class="origin_image zh-lightbox-thumb lazy" width="2560" data-original="https://pic4.zhimg.com/v2-9f75ee4b4d480005ff116b1beaceb123_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-9f75ee4b4d480005ff116b1beaceb123_b.jpg"/><figcaption>冯·诺依曼架构 来源：维基百科</figcaption></figure><p>1945年，天才科学家冯·诺依曼提出了一种计算机设计实现架构，奠定了现代计算机的理论基础。冯·诺依曼架构主要有几大部分：</p><ul><li>包含控制单元和逻辑运算单元的CPU</li><li>存储指令和数据的内存</li><li>输入和输出设备</li></ul><p>下文将简单描述CPU，指令、控制单元等概念。除了冯·诺依曼架构，哈佛架构也是一种计算机的实现方式。现代计算机经过了几十年的飞速发展，集百家之长，很难界定现代计算机到底是冯·诺依曼架构还是哈佛架构，这里暂不赘述。</p><h2><b>CPU工作原理</b></h2><p>CPU（Central Processing Unit），中文翻译为中央处理器，负责执行用户和操作系统下发的指令。CPU是计算机中最为核心的部分，经常被比作计算机的大脑。CPU只能接受01二进制语言，0和1用来控制高低电位。比如，一个加法运算，在x86处理器上的的二进制代码为：</p><div class="highlight"><pre><code class="language-text">01001000 00000001 11000011</code></pre></div><p>这样一行代码被称为<code>机器码</code>，它执行了加法操作。除了这样的加法，CPU的电路还要实现很多其他指令，如存取内存数据，进行逻辑判断等。不同厂商的电路设计不同，在电路上所能进行的二进制码不同。某类CPU能支持一种指令集（instruction set architecture）。指令集相当于一种设计图纸，规定了一种CPU架构实现哪些指令。参照指令集，硬件开发人员只需要关心如何设计电路，软件开发人员只关心如何用01机器码实现软件功能。比较常见的指令集有x86、ARM、MIPS、SPARC、Power等。x86和ARM被广泛应用在我们身边的电子产品上，相对比较知名，此外，龙芯实现了MIPS，IBM小型机则采用Power指令集。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-16400a966b15690df2ebe3cf74a143cd_b.jpg" data-size="normal" data-rawwidth="804" data-rawheight="617" class="origin_image zh-lightbox-thumb" width="804" data-original="https://pic2.zhimg.com/v2-16400a966b15690df2ebe3cf74a143cd_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;804&#39; height=&#39;617&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="804" data-rawheight="617" class="origin_image zh-lightbox-thumb lazy" width="804" data-original="https://pic2.zhimg.com/v2-16400a966b15690df2ebe3cf74a143cd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-16400a966b15690df2ebe3cf74a143cd_b.jpg"/><figcaption>单核计算机系统示意图</figcaption></figure><p>一个单核CPU的架构包括：</p><ul><li>Control Unit（CU）起协调管理功能。</li><li>Arithmetic Logic Unit（ALU）接受控制单元的命令，负责进行加减乘与或非运算。所有数据都存放在寄存器（Register）里。</li><li>寄存器以极高的速度与CU和ALU交互，通常小于1纳秒。从寄存器的名字可以看出来，里面的数据是临时寄存的，这些数据和指令会被ALU和CU拿来立即进行计算。如果寄存器没有CPU想要的数据，CPU会去内存或硬盘中读取。</li><li>CPU通过Bus（总线）读取内存或其他设备的数据。计算机中有多条总线。</li></ul><p>我们以一个加法运算来解释上面这些概念。对于一个<code>2 + 2</code>的加法，人类可以直接说出答案，但是换成<code>13234 + 87912</code>，就不得不拿出纸和笔来算一下了。计算机对这两次计算速度没有差别，其本质为半导体电路对两个数字执行加法操作。但与人类不同的是，计算机需要知道两个问题：</p><ol><li>本次所执行的是哪个指令。</li><li>该指令的执行对象是什么。</li></ol><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-7a2f11105ea45efa02d33c2eb96e22a5_b.jpg" data-size="normal" data-rawwidth="896" data-rawheight="659" class="origin_image zh-lightbox-thumb" width="896" data-original="https://pic2.zhimg.com/v2-7a2f11105ea45efa02d33c2eb96e22a5_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;896&#39; height=&#39;659&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="896" data-rawheight="659" class="origin_image zh-lightbox-thumb lazy" width="896" data-original="https://pic2.zhimg.com/v2-7a2f11105ea45efa02d33c2eb96e22a5_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-7a2f11105ea45efa02d33c2eb96e22a5_b.jpg"/><figcaption>指令执行过程</figcaption></figure><p>因此，控制单元先<code>取指令 Fetch</code>，然后<code>指令译码 Decode</code>解析出要执行什么指令，并确认指令是对哪些数据（操作数 operand）进行操作，并将操作数从主存加载到寄存器中。ALU<code>执行指令 Execute</code>后<code>结果写回 Store</code>。</p><h2><b>存储金字塔</b></h2><p>随着技术的发展，计算机的速度瓶颈已经变成了超高速的CPU运算速度与落后的数据读取速度之间的矛盾。CPU计算速度在纳秒级别，但是CPU读取主存的速度竟有百纳秒，CPU进行完计算后，要闲置几十倍的时间，实在是巨大的浪费。从计算本身来说，某个程序一般不需要把硬盘或主存中的所有数据都拿来进行计算，绝大多数时间只需要处理部分热点数据，因此，把热点数据加载到缓存中能解决绝大多数问题。综合计算速度、技术水平、生产成本，设计人员给CPU增加了很多中间的缓存Cache。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-270266f7ac0b430fca76e04b6853251f_b.jpg" data-size="normal" data-rawwidth="641" data-rawheight="373" class="origin_image zh-lightbox-thumb" width="641" data-original="https://pic4.zhimg.com/v2-270266f7ac0b430fca76e04b6853251f_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;641&#39; height=&#39;373&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="641" data-rawheight="373" class="origin_image zh-lightbox-thumb lazy" width="641" data-original="https://pic4.zhimg.com/v2-270266f7ac0b430fca76e04b6853251f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-270266f7ac0b430fca76e04b6853251f_b.jpg"/><figcaption>存储金字塔</figcaption></figure><p>CPU的寄存器存取速度极快，但是造价成本太高，发热量大，不能被大量采用。通常，CPU的寄存器只有几KB。L1 Cache和L2 Cache一般设计在CPU上，访问延迟在几纳秒只几十纳秒内，主存的访问延迟在百纳秒内。速度越快，意味着成本越高。所以硬件设计是在现有技术水平、期望计算速度、成本、散热等因素之间所做的trade-off。</p><h2><b>多核</b></h2><p>当单个CPU主频超过一定范围后，CPU成本和散热成了很大的问题，主频很难突破10GHz。为了获得更快的计算速度和更好的性能，芯片设计者决定绕过主频，采用人海战术，在一块CPU中增加多个核心（Core）。</p><p>一个核心是一个可以运行指令的独立单元，它包含了前面所提到的ALU和寄存器，并配备L1和L2 Cache。多个核心共享L3 Cache。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-0d480b324c470945aab834e727aa9986_b.jpg" data-size="normal" data-rawwidth="538" data-rawheight="340" class="origin_image zh-lightbox-thumb" width="538" data-original="https://pic3.zhimg.com/v2-0d480b324c470945aab834e727aa9986_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;538&#39; height=&#39;340&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="538" data-rawheight="340" class="origin_image zh-lightbox-thumb lazy" width="538" data-original="https://pic3.zhimg.com/v2-0d480b324c470945aab834e727aa9986_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-0d480b324c470945aab834e727aa9986_b.jpg"/><figcaption>多核和cache</figcaption></figure><p>上图中是一个多核处理器的电路图，每个Core旁边的黑色圆圈分别为L1和L2 Cache。可以看到CPU中，各类Cache占用了很大的空间。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-c496e55fef3edbf461fdc45fadf9adf2_b.jpg" data-size="normal" data-rawwidth="688" data-rawheight="248" class="origin_image zh-lightbox-thumb" width="688" data-original="https://pic3.zhimg.com/v2-c496e55fef3edbf461fdc45fadf9adf2_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;688&#39; height=&#39;248&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="688" data-rawheight="248" class="origin_image zh-lightbox-thumb lazy" width="688" data-original="https://pic3.zhimg.com/v2-c496e55fef3edbf461fdc45fadf9adf2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-c496e55fef3edbf461fdc45fadf9adf2_b.jpg"/><figcaption>多处理器多核结构</figcaption></figure><p>高性能服务器通常可以支持多个处理器，提供更多计算核心。支持单个CPU的服务器被称为单路服务器，支持两个CPU的服务器被称为双路服务器，支持四个CPU的服务器被称为四路服务器。上图展示了Intel的四路架构，系统支持四个CPU，假如每块CPU内有8个核心，系统可对外提供32核计算能力。</p><h2><b>线程与进程</b></h2><p>前面都是计算机硬件知识，而线程和进程则是操作系统控制这些硬件而创造的软件概念。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-847c07bece03e6b37f9b4a68e37ef9e2_b.jpg" data-size="normal" data-rawwidth="400" data-rawheight="309" class="content_image" width="400"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;400&#39; height=&#39;309&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="400" data-rawheight="309" class="content_image lazy" width="400" data-actualsrc="https://pic3.zhimg.com/v2-847c07bece03e6b37f9b4a68e37ef9e2_b.jpg"/><figcaption>线程与进程</figcaption></figure><p>进程（Process）具有单独的计算资源，如内存空间。</p><p>线程（Thread）是进程的一个子集，一个进程默认启动一个线程，也可以通过多线程编程，启动多个线程，多个线程共享共享进程的资源。</p><p>在多核架构出现之前，CPU在某个特定时刻只能执行某个程序，无法并行。就像人在某个时刻只能做一件事情，不可能“吃着火锅还唱着歌”，因为两项活动都要占用嘴。如果要干另一件事，就必须把其中一件事停下来。</p><p>在多核架构出现之前，CPU在某个特定时刻只能执行某个程序，无法并行。就像人在某个时刻只能做一件事情，不可能“吃着火锅还唱着歌”，因为两项活动都要占用嘴。如果要干另一件事，就必须把其中一件事停下来。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-335bb38660bb3c01a533eb845d454cb9_b.jpg" data-size="normal" data-rawwidth="1388" data-rawheight="420" class="origin_image zh-lightbox-thumb" width="1388" data-original="https://pic2.zhimg.com/v2-335bb38660bb3c01a533eb845d454cb9_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1388&#39; height=&#39;420&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1388" data-rawheight="420" class="origin_image zh-lightbox-thumb lazy" width="1388" data-original="https://pic2.zhimg.com/v2-335bb38660bb3c01a533eb845d454cb9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-335bb38660bb3c01a533eb845d454cb9_b.jpg"/><figcaption>单核单线程</figcaption></figure><p>但前文提到，CPU处理速度是纳秒级，速度非常快，所以在单核时代，为了同时处理多项任务，CPU先“吃会火锅”，再“唱会歌”，边吃边唱，以这种形式实现多线程。单个CPU每次切换不同的线程任务，会产生一些资源开销。吃饭和唱歌之间，总要让人稍微歇歇嘛！在CPU上快速在多个任务间切换，对于使用者来说，就像并发（Concurrent）地执行了多个任务一样。</p><p>以网页浏览器为例，浏览器打开一个网页时通常需要下载网页中素材同时也要渲染成美观的画面。在单核场景下，时间被切成了不同的片段，某段时间只能用来做渲染、缓存或下载中的一项任务。每个任务都有优先级，CPU优先执行高优先级的任务。比如，浏览器打开一个新网页时，要第一时间把网页展示出来，背景音乐下载比较慢，可以等网站渲染好后再下载，所以有时候背景音乐会比网页晚半分钟。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-60fd763ce363d80afa860cdae305dec5_b.jpg" data-size="normal" data-rawwidth="1388" data-rawheight="622" class="origin_image zh-lightbox-thumb" width="1388" data-original="https://pic2.zhimg.com/v2-60fd763ce363d80afa860cdae305dec5_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1388&#39; height=&#39;622&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="1388" data-rawheight="622" class="origin_image zh-lightbox-thumb lazy" width="1388" data-original="https://pic2.zhimg.com/v2-60fd763ce363d80afa860cdae305dec5_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-60fd763ce363d80afa860cdae305dec5_b.jpg"/><figcaption>多核多线程</figcaption></figure><p>多核架构提供给用户多个可以独立计算的核心，这也意味着计算机可以同时并行执行多项任务，即<b>并行计算（Parallel Computing）</b>。那么一个网页浏览器使用一个核渲染网页，另一个核缓存其他素材，第三个核下载背景音乐。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-a3d10367b08c816fcf6aa352db8be62d_b.jpg" data-size="normal" data-rawwidth="3104" data-rawheight="1818" class="origin_image zh-lightbox-thumb" width="3104" data-original="https://pic2.zhimg.com/v2-a3d10367b08c816fcf6aa352db8be62d_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;3104&#39; height=&#39;1818&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="3104" data-rawheight="1818" class="origin_image zh-lightbox-thumb lazy" width="3104" data-original="https://pic2.zhimg.com/v2-a3d10367b08c816fcf6aa352db8be62d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-a3d10367b08c816fcf6aa352db8be62d_b.jpg"/><figcaption>使用htop查看CPU和内存利用率</figcaption></figure><p>上图是我的macOS性能监控的一个软件（htop），Windows上类似的软件是任务管理器。图片绿色横条上方展示了当前8个CPU核的及内存利用率，绿色横条下方是我启动的多个进程，其中标蓝色的是我的Chrome浏览器的进程，我还启动了Photoshop等软件。</p><p>当多个核心都处理相同任务，极有可能使用同一块数据，就有可能出现数据读写的问题。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-24e5ab6ad8f5dc8e938f0582b2ce333f_b.jpg" data-size="normal" data-rawwidth="678" data-rawheight="373" class="origin_image zh-lightbox-thumb" width="678" data-original="https://pic4.zhimg.com/v2-24e5ab6ad8f5dc8e938f0582b2ce333f_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;678&#39; height=&#39;373&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="678" data-rawheight="373" class="origin_image zh-lightbox-thumb lazy" width="678" data-original="https://pic4.zhimg.com/v2-24e5ab6ad8f5dc8e938f0582b2ce333f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-24e5ab6ad8f5dc8e938f0582b2ce333f_b.jpg"/><figcaption>线程安全问题</figcaption></figure><p>例如，进行<code>i = i + 1</code>操作，如果两个线程短时间内都对变量<code>i</code>加一，变量应该被加了两次。由于两个线程相隔时间太短，加上前面所说的缓存机制，计算的过程和临时结果还在寄存器和L1缓存，没来得及写到主存上。线程B读到还是较老的数据，这样就出现了数据不一致的情况。这种问题被称为线程安全问题。一般需要使用<b>锁</b>来处理线程安全问题。</p><p>本专栏将在未来的文章中分享多线程编程和线程安全的具体案例。</p><h2><b>小结</b></h2><p>现代CPU一般使用缓存（Cache）来解决CPU读写主存慢的问题；使用多核来并行计算以加速程序运行。并行计算一般需要多线程技术，如何操作多线程对编程人员提出了挑战。</p>

&nbsp;
## reference
[计算机基础 | 多核、缓存...现代CPU是如何工作的](https://zhuanlan.zhihu.com/p/73937739)
